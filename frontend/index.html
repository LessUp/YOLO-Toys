<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YOLO-Toys - 多模型实时视觉识别系统</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="header-left">
      <h1>
        <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v10"/><path d="m4.22 4.22 4.24 4.24m7.08 7.08 4.24 4.24"/>
          <path d="M1 12h6m6 0h10"/><path d="m4.22 19.78 4.24-4.24m7.08-7.08 4.24-4.24"/>
        </svg>
        YOLO-Toys
      </h1>
      <span class="version-badge">v2.0</span>
    </div>
    <div class="header-right">
      <select id="quickModelSelect" class="quick-model-select" title="快速切换模型"></select>
      <button id="themeToggle" class="icon-btn" title="切换深色/浅色主题">
        <svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        <svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line></svg>
      </button>
      <button id="toggleSidebar" class="icon-btn" title="显示/隐藏检测结果侧边栏">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
      </button>
    </div>
  </header>

  <main>
    <div class="stage-container">
      <div id="emptyState" class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/><line x1="16" y1="5" x2="22" y2="5"/><line x1="19" y1="2" x2="19" y2="8"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
        <h3>开始视觉识别</h3>
        <p>点击"开始摄像头"启动实时检测，或上传图片进行单次推理</p>
      </div>
      <canvas id="canvas"></canvas>
      <video id="video" autoplay playsinline muted style="display:none"></video>
      <div id="overlayInfo" class="overlay-info" hidden>
        <div class="overlay-stat"><span class="label">推理</span><span id="overlayInferTime" class="value">-</span></div>
        <div class="overlay-stat"><span class="label">目标</span><span id="overlayObjects" class="value">0</span></div>
      </div>
      <div id="captionResult" class="caption-result" hidden>
        <div class="caption-label">图像描述</div>
        <div id="captionText" class="caption-text"></div>
      </div>
    </div>

    <aside class="sidebar" id="detectionsSidebar">
      <div class="sidebar-header"><span>检测结果</span></div>
      <div class="sidebar-content">
        <div id="permissionStatus" class="notice" hidden></div>
        <div class="stat-group">
          <div class="stat-row"><span>总检测数</span><span id="summaryTotal" class="stat-value">0</span></div>
          <div class="stat-row"><span>当前模型</span><span id="summaryModel" class="stat-value">-</span></div>
          <div class="stat-row"><span>计算设备</span><span id="summaryDevice" class="stat-value">-</span></div>
          <div class="stat-row"><span>推理延迟</span><span id="summaryTiming" class="stat-value">-</span></div>
        </div>
        <div class="sidebar-section"><h3>类别统计</h3><div class="class-list" id="classCounts"><div class="empty-hint">暂无检测结果</div></div></div>
      </div>
    </aside>
  </main>

  <div class="control-bar">
    <button id="start" class="primary" title="启动摄像头进行实时检测">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>
      开始摄像头
    </button>
    <button id="stop" class="danger" disabled title="停止摄像头和检测">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
      停止
    </button>
    <div class="divider"></div>
    <label class="file-upload" title="选择本地图片文件上传">
      <input id="imageFile" type="file" accept="image/*" />
      <span class="upload-btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>上传图片</span>
    </label>
    <button id="inferImage" title="对上传的图片进行一次推理"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>推理</button>
    <div class="spacer"></div>
    <div id="stats" class="stats-bar">就绪</div>
    <button id="openSettings" title="打开详细设置面板"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>设置</button>
  </div>

  <div class="settings-overlay" id="settingsOverlay">
    <div class="settings-panel">
      <div class="settings-header"><h3>配置选项</h3><button id="closeSettings" class="icon-btn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
      <div class="settings-content">
        <div class="settings-section">
          <h3>🔗 连接设置</h3>
          <div class="form-group"><label>服务地址 <span class="help-text" title="后端 API 服务器地址">(?)</span></label><input id="server" type="text" placeholder="http://localhost:8000" /></div>
          <label class="checkbox-label"><input id="useWs" type="checkbox" checked /> 使用 WebSocket <span class="help-text" title="WebSocket 延迟更低，推荐实时检测">(推荐)</span></label>
        </div>

        <div class="settings-section">
          <h3>🤖 模型选择</h3>
          <div class="model-tabs" id="modelTabs">
            <button class="tab-btn active" data-cat="yolo_detect" title="快速目标检测">YOLO 检测</button>
            <button class="tab-btn" data-cat="yolo_segment" title="像素级实例分割">分割</button>
            <button class="tab-btn" data-cat="yolo_pose" title="人体关键点检测">姿态</button>
            <button class="tab-btn" data-cat="hf_detr" title="Transformer 检测器">DETR</button>
            <button class="tab-btn" data-cat="multimodal" title="图像描述和问答">多模态</button>
          </div>
          <div class="model-list" id="modelList"></div>
          <div class="form-group"><label>自定义模型 <span class="help-text" title="输入模型路径或 HuggingFace ID">(?)</span></label><input id="customModel" type="text" placeholder="例如: yolov8x.pt" /></div>
          <div class="form-group"><label>计算设备 <span class="help-text" title="GPU 速度更快">(?)</span></label><select id="device"><option value="auto">自动选择</option><option value="cpu">CPU</option><option value="mps">MPS (Mac)</option><option value="cuda:0">CUDA:0</option></select></div>
          <label class="checkbox-label"><input id="half" type="checkbox" /> FP16 半精度 <span class="help-text" title="加速推理，仅 NVIDIA GPU">(CUDA only)</span></label>
        </div>

        <div class="settings-section">
          <h3>⚙️ 推理参数</h3>
          <div class="form-grid">
            <div class="form-group"><label>置信度 <span class="help-text" title="过滤低置信度检测">(?)</span></label><input id="conf" type="number" min="0.05" max="0.95" step="0.05" value="0.25" /></div>
            <div class="form-group"><label>IoU 阈值 <span class="help-text" title="非极大值抑制阈值">(?)</span></label><input id="iou" type="number" min="0.1" max="0.95" step="0.05" value="0.45" /></div>
            <div class="form-group"><label>最大检测数 <span class="help-text" title="每帧最多物体数">(?)</span></label><input id="maxDet" type="number" min="10" max="1000" step="10" value="300" /></div>
            <div class="form-group"><label>推理尺寸 <span class="help-text" title="图像缩放尺寸">(?)</span></label><input id="imgsz" type="number" min="160" step="32" value="640" /></div>
          </div>
        </div>

        <div class="settings-section">
          <h3>📺 显示设置</h3>
          <div class="form-grid">
            <div class="form-group"><label>发送帧率</label><select id="fps"><option value="3">3 fps</option><option value="5" selected>5 fps</option><option value="10">10 fps</option><option value="30">30 fps</option></select></div>
            <div class="form-group"><label>发送宽度</label><select id="sendSize"><option value="320">320px</option><option value="480">480px</option><option value="640" selected>640px</option></select></div>
            <div class="form-group"><label>JPEG 质量</label><select id="quality"><option value="0.6">60%</option><option value="0.8" selected>80%</option><option value="0.9">90%</option></select></div>
          </div>
          <div class="display-toggles">
            <label class="checkbox-label" title="显示检测框"><input id="showBoxes" type="checkbox" checked />边框</label>
            <label class="checkbox-label" title="显示类别和置信度"><input id="showLabels" type="checkbox" checked />标签</label>
            <label class="checkbox-label" title="显示分割掩膜"><input id="showMasks" type="checkbox" checked />掩膜</label>
            <label class="checkbox-label" title="显示人体关键点"><input id="showKeypoints" type="checkbox" checked />关键点</label>
            <label class="checkbox-label" title="显示骨架连线"><input id="showSkeleton" type="checkbox" checked />骨架</label>
            <label class="checkbox-label" title="显示性能信息"><input id="showOverlay" type="checkbox" checked />叠加层</label>
          </div>
          <div class="form-group"><label>掩膜透明度</label><input id="maskAlpha" type="range" min="0.1" max="0.8" step="0.05" value="0.3" /></div>
        </div>

        <div class="settings-section" id="multimodalSection">
          <h3>💬 多模态设置</h3>
          <div class="form-group"><label>开放词汇查询 <span class="help-text" title="用于 OWL-ViT 检测，逗号分隔">(?)</span></label><input id="textQueries" type="text" placeholder="person, car, dog" /></div>
          <div class="form-group"><label>VQA 问题 <span class="help-text" title="对图像提问">(?)</span></label><input id="vqaQuestion" type="text" placeholder="What is in this image?" /></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>
  <script src="app.js"></script>
</body>
</html>
